# PAC testing with Jira - pre-filled images

To test PAC with a real instance of Jira, we needed a containerized (or similar) Jira, but according to our research on [PAC issues #19](https://github.com/Praqma/Praqmatic-Automated-Changelog/issues/19) we can currently not create such unattended Jira installation. At least not one that is fully automated from a script.
The problem is that Jira Setup Wizard running the first time Jira starts.

All kinds of ugly hacks to work around it, snapshotting databases etc., we decided to just use containers and commit and push them after going throught he initial setup of Jira and adding test data.

This readme describes how these prefilled Jira and database container are created - my worklog.


Our original approach for using a jira software server as a container (including a postgres database) is from the [blacklabelops/jira docker image](https://hub.docker.com/r/blacklabelops/jira/).

As described there, you can easily spin a jira with postgres up like this:

```
$ docker run --name postgres -d \
    -e 'POSTGRES_DB=jiradb' \
    -e 'POSTGRES_USER=jiradb' \
    -e 'POSTGRES_PASSWORD=jellyfish' \
    postgres:9.4
$ docker run --name postgres -d \
    -e 'DB_USER=jiradb' \
    -e 'DB_PASS=jellyfish' \
    -e 'DB_NAME=jiradb' \
    sameersbn/postgresql:9.4-12
```

...but then you need to go through the Jira setup wizard what we don't want. We just need a running Jira.

So here is the story on how to create a Jira image ready for testing.


**Few notes:**

* License nees to be `JIRA Software (server)` so we get the projectype software in Jira 7.x that fits the autogenerated test data from http://jumble.expium.com/
* Seem like we can re-use the same license key for new servers, even though Server ID changes.
* !**License expire soon!** - it is an evaluation license, we are not allowed to distribute a developer license.
* Project types: https://confluence.atlassian.com/adminjiraserver070/jira-applications-and-project-types-overview-776637041.html


## Step 1 - Customizing blacklabelops/jira and postgres images

We need to build custom images, based on the above ones, because we don't want the volumes entries, that makes the containers not persist data inside the container.
We need to persist our state with finished Jira Setup Wizard and initial database setup.

We simple do that by:

* clone the git repo with the Docker files
* edit the Docker file, to remove volume so that data persisted inside container instead of host filesystem
* build local image, we can re-use to create the one with a fully running Jira instance.

**Worklog:**


```
$ git clone git@github.com:blacklabelops/jira.git
Cloning into 'jira'...
remote: Counting objects: 456, done.
remote: Compressing objects: 100% (9/9), done.
remote: Total 456 (delta 3), reused 0 (delta 0), pack-reused 447
Receiving objects: 100% (456/456), 78.42 KiB | 61.00 KiB/s, done.
Resolving deltas: 100% (267/267), done.
Checking connectivity... done.

$ cd jira/

$ git log -n1
commit 286c100623cf22e1e4ec9c9ee42d11688dc878c9
Author: Steffen Bleul <blacklabelops@itbleul.de>
Date:   Wed Apr 13 19:42:25 2016 +0200

    Update download location of SSLPoke

$ vim Dockerfile 

$ git diff
diff --git i/Dockerfile w/Dockerfile
index 7f3ee8e..e288568 100644
--- i/Dockerfile
+++ w/Dockerfile
@@ -87,7 +87,9 @@ RUN apk add --update                                    \
 
 USER jira
 WORKDIR ${JIRA_HOME}
-VOLUME ["/var/atlassian/jira"]
+# FOR Praqmatic-Automated-Changelog testing we need data persisted into the container
+# so we can distribute a binary image (temporary solution)
+#VOLUME ["/var/atlassian/jira"]
 EXPOSE 8080
 ENTRYPOINT ["/usr/local/share/atlassian/docker-entrypoint.sh"]
 CMD ["jira"]

$ docker build -t praqma/pac_test_jira:`date +%Y%d%m-%H%M%S`

$ cd ..
$ rm -rf jira
```

And more or less the same for the postgres image we will be using:

```
$ git clone git@github.com:sameersbn/docker-postgresql.git
Cloning into 'docker-postgresql'...
remote: Counting objects: 992, done.
remote: Total 992 (delta 0), reused 0 (delta 0), pack-reused 992
Receiving objects: 100% (992/992), 180.44 KiB | 119.00 KiB/s, done.
Resolving deltas: 100% (561/561), done.
Checking connectivity... done.

$ cd docker-postgresql/

$ git log -n1
commit b82efb6cd2ddb9875aeb292b6b79b20116b1bd35
Author: Sameer Naik <sameer@damagehead.com>
Date:   Wed Mar 30 23:00:59 2016 +0530

    release 9.4-18

$ vim Dockerfile 

$ git diff
diff --git i/Dockerfile w/Dockerfile
index 38fb3e2..6138cc0 100644
--- i/Dockerfile
+++ w/Dockerfile
@@ -28,6 +28,9 @@ COPY entrypoint.sh /sbin/entrypoint.sh
 RUN chmod 755 /sbin/entrypoint.sh
 
 EXPOSE 5432/tcp
-VOLUME ["${PG_HOME}", "${PG_RUNDIR}"]
+
+# FOR Praqmatic-Automated-Changelog testing we need data persisted into the container
+# so we can distribute a binary image (temporary solution)
+#VOLUME ["${PG_HOME}", "${PG_RUNDIR}"]
 WORKDIR ${PG_HOME}
 ENTRYPOINT ["/sbin/entrypoint.sh"]

$ docker build -t praqma/pac_test_postgres-for-jira:`date +%Y%d%m-%H%M%S` .

$ cd..
$ rm -rf docker-postgresql
```

Then we have the following images:

	$ docker images | grep praqma/pac_test
	praqma/pac_test_postgres-for-jira                            20161504-143355         8cee8ed7f576        About a minute ago   231.4 MB
	praqma/pac_test_jira                                         20161504-142659         6a21c7bcd50a        3 minutes ago        547.2 MB


## Step 2 - Running our pac_test Jira container to do initial Jira setup

Now we have the two images that persist data inside the container, so they can now be configured:

	docker run --name pac_test_postgres-for-jira-temp -d -e 'DB_USER=jiradb' -e 'DB_PASS=jellyfish' -e 'DB_NAME=jiradb' praqma/pac_test_postgres-for-jira:20161504-143355
	docker run -d --name pac_test_jira-temp -e "JIRA_DATABASE_URL=postgresql://jiradb@postgres/jiradb" -e "JIRA_DB_PASSWORD=jellyfish" --link pac_test_postgres-for-jira-temp:postgres -p 28080:8080 praqma/pac_test_jira:20161504-142659

### Jira initial Setup Wizard choices

Open http://localhost:28080 and follow the guide taking the following choices:


**Set up application properties:**

* Application Title: `PAC Test Jira`  - _non default_
* Mode: `Public` (Anyone can sign up to create issues) - _non default_
* Base URL: `http://localhost:28080`

NOTICE: LICENSE RUNS OUT on **15 May 2016**

**Specify your license key:**

Server ID: BHQ7-UI8N-8RZM-SBGR

License (from Bue Petersen Atlassian account - Jira Software Server) generated for above server ID:

AAABcQ0ODAoPeNp9UU1Pg0AUvPMrNvGiBwhUkabJJrawKqalFaoH42WLr7qGLuvbpdp/LwWMVVuP7
2Pmzcw7ukRBhgqJ5xM3GJz5A/+UhNGc9Fzv3HpGAPlSKgXojEUOUgN7EkaUkrJkztJZGmfMSqrVA
nC6vNOAmtqe9SqQO3+6swrzF64h4gbolt52z2zPtzri+UZBwldAw+lkwtIwHo6/RuxDCdzs4PwtL
iyl4blhEy4KuqjgQiF/W3FHgrEywDVgHNHR9W1g38X9xO6nDxM7G12lrTyF5VOVG2db2LpcmneO4
NR8Yg3UYAXt2mHXe7LZZ6FWJw1ILvMDNv5R8yfC7k7taxxHGUvscRC4get6Vl3QH41/aDPD0QDSJ
S80WFN85lJo3vgbVUBmUA81SCtEaLq/H1a0Ku7rrS2m9yMKqN2iQqG7FCPQOQrVsN/E6ZBknQxy3
D7p5HFA2JoXVXOr1X3oDfsC3j2+i/vmbOtP9Xf+UTAsAhQiVpWhYUrRD5cMHYKvMVkgmuZSDgIUZ
VqzgfBKknpDuyvLtwdkElKr06c=X02i2


**Set up administrator account:**

Full name: `PAC Admin for Jira test`
Email Address: `support@praqma.net`
Username: admin
Password: admin

**Set up email notifications:**

Configure Email Notifications: `Later`


... `Finish` the setup wizard.


### User configuration `admin`

Language: `English (United Status)[Default]`

* Did not chose an avatar
* Skipped quick tour
* Skipped creating first project


## Step 3 - Importing test data

Using http://jumble.expium.com/ we generated some Jira test data as a json file. Neat website - thanks for that.

Check the following images to see how test data was generated or read the json file:

* [test/resources/jira-env/Selection_050.png](Selection_050.png)
* [test/resources/jira-env/Selection_052.png](Selection_052.png)
* [test/resources/jira-env/Selection_053.png](Selection_053.png)

Import them into the running Jira instance:


* Jira Administration -> System -> External System Import -> JSON and chose file `test/resources/jira-env/0578a7b0-fd81-11e5-a150-91d01466654e.json`
* leave users in-active
* perform re-index

Check `test/resources/jira-env/0578a7b0-fd81-11e5-a150-91d01466654e-data-import.log` for import details results.

## Step 4- Creating the image with a ready Jira


Stop the running container with the configured Jira, commit and push it to be used again and again for functional testing...

```
$ docker stop pac_test_jira-temp
$ docker stop pac_test_postgres-for-jira-temp
$ docker commit -m "Jira initial setup and basic test data" -a "Bue Petersen" pac_test_jira-temp praqma/pac_test_jira:v1
$ docker commit -m "Jira initial setup and basic test data" -a "Bue Petersen" pac_test_postgres-for-jira-temp praqma/pac_test_postgres-for-jira:v1
$ docker rm pac_test_jira-temp pac_test_postgres-for-jira-temp
$ docker push praqma/pac_test_jira:v1
$ docker push praqma/pac_test_postgres-for-jira:v1
```

## Step X - refreshed license

Followed all the above steps 1-4 again to renew a 3 month trial license and published a new binary image on the hub.

* a new license was used
* same docker images used
* same test data imported again, didn't update logfile output
* version "v2" of the images are out on the hub now (actually only needed to update the database though)
